---
title: "Rowley_HLM2_Final"
author: "Brock Rowley"
date: "6/8/2021"
output:
  html_document:
    css: table_style.css
bibliography: r-references.bib
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(kableExtra)
library(lme4)
library(here)
library(rio)
library(equatiomatic)
library(performance)
library(readr)
library(brms)
library(insight)
library(broom.mixed)
library(gghalves)
library(tidybayes)

year7 <- rio::import(here::here("data", "Year7_MLM.sav"))
view(year7)
### Explanation of variables:
# * School = School ID.
# * SID = Student ID.
# * RaceEthnicity = Categorical variable of student race.
# * OSS_1stRef = True/False (logical) student received Out of School Suspension
# (OSS) on first referral in school year for substance possession.
# * Alcohol.1, Drugs.1, Tobacco.1 = True/False (logical) student possessed named
# substance in 1st referral.
# * subtype = categorical variable of substance possessed on first referral.
# Mutually exclusive categories eliminate some co-ocurrence that happened.
# Probably won't use this variable, but there if needed.
# * Gender = Male (0), Female(1)
# * ODRCount = # of Office Discipline Refferal (ODRs) for substance in that school
# year for each student.
# * Grade = grade of student at time of referral.
# * IEP = True/False (logical) if student had Individualize Education Plan (IEP)
# at time of referral.
# * BLW_Sample = Flag for students in schools that had minimum of 5% students in
# each abbreviated race category (e.g., B=Black, L=Latinx) race categories
# referred for substances in year. Likely not needed for these student-level
# analyses.
# * Tier1Fidelity: school was implementing Positive Behavioral Intervention
# Supports (PBIS) with fidelity (1) or not (0) based on one of three measures that
# year.
```

```{r clean_group, include = FALSE}
year7$PrimarySubstanceType.1 <- as.factor(year7$PrimarySubstanceType.1)

year7 <- year7 %>%
   mutate(subtype = ifelse(PrimarySubstanceType.1 == 13, "Tobacco", 
                     ifelse(PrimarySubstanceType.1 == 14, "Alcohol", "Drugs")), 
          Alcohol.1 = as.factor(year7$Alcohol.1),
          Drugs.1 = as.factor(year7$Drugs.1),
          Tobacco.1 = as.factor(year7$Tobacco.1),
          RaceEthnicity = as.factor(year7$RaceEthnicity),
          School = as.factor(year7$School),
          District = as.factor(year7$District),
          RaceEthnicity = case_when(RaceEthnicity == 1 ~ "Native",
                                    RaceEthnicity == 2 ~ "Asian",
                                    RaceEthnicity == 3 ~ "Latinx",
                                    RaceEthnicity == 4 ~ "Black",
                                    RaceEthnicity == 5 ~ "White",
                                    RaceEthnicity == 8 ~ "Pacific_Islander",
                                    RaceEthnicity == 44 ~ "Multi"),
          RaceEthnicity = as.factor(year7$RaceEthnicity))

grouped <- year7 %>%
  group_by(RaceEthnicity) %>%
  count()
view(grouped)
```

# Introduction:
  Student substance misuse is an ongoing problem in schools across
the United States, and it is outside the training and expertise of most
educators. Nonetheless, school staff are presented with situations in which
students bring substances to campus or arrive under the influence of them.
Despite the evidence that zero-tolerance policies do not improve school safety
nor student behavior (American Psychological Association, 2008), the likely
default response in contemporary schools to substance-related behavior occurs
through their discipline systems. Although the national mindset is moving toward
a more inclusive approach to behavioral health, this study seeks to determine to
what extent school practices have shifted with it. Specifically, this study
seeks to examine how use of out-of-school suspension (OSS) differs by substance
possessed and student race/ethnicity.

# Research Questions:
1. To what extent does the substance a student possessed for their referral
(Alcohol, Tobacco, or Drugs) predict whether or not they receive an out of
school suspension for substance possession? 
2. To what extent does student race predict whether or not a student receives an
out of school suspension for substance possession? 
3. To what extent is there an interaction between student race and substance in
predicting out of school suspension for substance possession?

# Method:
  The data sample for the project comes from the web-based School-Wide Information System (SWIS) for collecting and analyzing school discipline data in the form of office discipline referrals (ODRs; May et al., 2013) following a formal, written data request submitted by the first author. The sample of 2018-19 referrals included 30,773 students in grades 6-12 across 45 states. Schools in the 2018-19 dataset numbered 1,903 within 1,008 districts. The majority of students in the dataset were coded as White (52%). The next largest group was Latinx students (23%), followed by Black/African American (10%), students of more than one race (2%), Indigenous (2%), Pacific Islander (1%), and Asian (1%). 

# Procedure:
  Analysis was done using only the first referrals for substance possession for each student in the dataset to eliminate concerns about possible confounding of analyses related to decision-making with subsequent referrals. Prior to beginning this course, the following steps were taken to prepare the data set for analysis: (a) the dataset was restricted to contain only the 2018-19 school year, (b) variables were created including a dummy coded variable for use of suspension and expulsion for each referral and a dummy coded variable for type of substance possessed for each referral, (c) the dataset was pivoted the dataset wider by student so that referrals, in order of date of receipt, were nested with students, (e) the sample was further restricted to grades 6-12 and (f) the dataset was restricted only variables of interest. For analysis in R, the variables needed to be properly formatted as factors to use multilevel modeling. Missing data was handled by listwise deletion for instances where an individual student's race or ethnicity was not available (i.e., listed as Not Applicable, NA). The race or ethnicity identifier was drawn from the National Center on Educational Statistics approach for collecting and disseminating extant data. In this case, 7.7% (2360 of 30773 observations) of the data was removed from analyses because there was insufficient demographic information.

# Measures:
## Dependent Variable
  The receipt (or not) of OSS as a consequence of a behavior referral is the
primary dependent variable. Per the SWIS training materials, OSS is defined as a
period when a student is not allowed on campus. Substance type was one dependent
variable with three categories: Alcohol Possession, Drug Possession, or Tobacco
Possession. For analysis, these codes were turned into dummy-coded variables.
Race/Ethnicity was modeled as a categorical variable and included codes for
Asian, Black/African American, Latinx, Indigenous, Multiracial (more than one
race), Pacific Islander, and White.

# Analytic Plan:
**Table 1**
```{r table_plot, echo = FALSE, warning = FALSE}
# Cross tabs of race ethnicity by primary substance type
tablesubxrace <- year7 %>%
  group_by(RaceEthnicity, subtype) %>%
  summarise(n = n()) %>%
  spread(subtype, n)
view(tablesubxrace)

kable(
  tablesubxrace,
  format = "html",
  col.names = c("RaceEthnicity", "Alcohol", "Drugs", "Tobacco"),
  align = c("l", "c", "c", "c"),
  caption = "Number of Office Refferals by Race and Substance Type"
  ) %>%
  kable_styling(full_width = TRUE) %>%
  row_spec(row = 0, align = "c") %>%
   footnote(
    general_title = "Note.",
    general = "1 = Native, 2 = Asian, 3 = Latinx, 4 = Black, 5 = White, 8 = Pacific_Islander, 44 = Multi.",
   footnote_as_chunk = TRUE
    )
# same_plot <- ggplot(year7, aes(ODRCount,RaceEthnicity)) +
# geom_line() +
# facet_wrap(~subtype)
# same_plot

rain <- ggplot(year7, aes(x = RaceEthnicity, y = OSS_1stRef)) +
  ggdist::stat_halfeye(
    adjust = .5,
    width = .6,
    .width = 0,
    justification = -.2,
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15,
    outlier.shape = NA
  ) +
  ## add justified jitter from the {gghalves} package
  gghalves::geom_half_point(
    ## draw jitter on the left
    side = "l",
    ## control range of jitter
    range_scale = .4,
    ## add some transparency
    alpha = .3
  ) +
  coord_cartesian(xlim = c(1.2, NA), clip = "off")
rain
```

  Descriptive analysis indicates some differences in likelihood of receiving OSS
based on substance type and student race/ethnicity; however, the crosstab table
shows that there are different possession trends by student race/ethnicity. For
all research questions, modeling accounted for variance at the individual
student and school levels. Modeling with nesting at the district level was
considered as well, but over 64% of districts had only one school in the data
set and 85% of districts had two or fewer schools, meaning interpretation of
this variance at the district-level would have limited usefulness if analyzed
with a three-level model.

```{r unconditional_model, echo = FALSE, message = FALSE, include = FALSE}
# Unconditional models
uncond <- glmer(OSS_1stRef ~ 1 + (1|School), data = year7,
                family = binomial)

# look at distribution schools per district: 84% have 2 or fewer

summary(uncond)

# translate to probability:
brms::inv_logit_scaled(fixef(uncond))

#69% chance of OSS

# Probability for an individual 1 SD below
brms::inv_logit_scaled(-0.40 - 0.95)
# Probability for an individual 1 SD above
brms::inv_logit_scaled(-0.40 + 0.95)

tidy_uncond <- tidy(uncond, "ran_vals", conf.int = TRUE) %>%
  mutate(level = fct_reorder(level, estimate))

uncond_brm <- brm(OSS_1stRef ~ 1 + (1|School), data = year7,
            family = bernoulli(link = "logit"),
            cores = 4,
            backend = "cmdstanr")

summary(uncond_brm)

pp_check(uncond_brm, type = "bars")

m0_posterior <- get_parameters(uncond_brm)
head(uncond_brm)
```

```{r plots}
ggplot(tidy_uncond, aes(estimate, level)) +
  geom_linerange(aes(xmin = conf.low, xmax = conf.high),
                 alpha = 0.01) +
  geom_point(color = "#1DA1F2") +
  # get rid of some plot elements
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank())

ggplot(m0_posterior, aes(b_Intercept)) +
  geom_density(fill = "#1DA1F2") +
  geom_vline(aes(xintercept = mean(b_Intercept)),
             color = "magenta",
             size = 1.2)
```

# Research Question One:
  Analyze use of OSS by substance, logistic multi-level modeling was used
examine differential odds ratios while accounting for variance in decisions
attributable to nesting at the school-level. Substance type variables were
modeled with fixed effects, while variance at the school-level was allowed to
vary as a random effect.
$$
\begin{aligned}
  \operatorname{OSS\_1stRef}_{i}  &\sim \operatorname{Binomial}(n = 1, \operatorname{prob}_{\operatorname{OSS\_1stRef} = 1} = \widehat{P}) \\
    \log\left[\frac{\hat{P}}{1 - \hat{P}} \right] &=\alpha_{j[i]} + \beta_{1}(\operatorname{Alcohol.1}_{\operatorname{1}}) + \beta_{2}(\operatorname{Drugs.1}_{\operatorname{1}}) \\
    \alpha_{j}  &\sim N \left(\mu_{\alpha_{j}}, \sigma^2_{\alpha_{j}} \right)
    \text{, for School j = 1,} \dots \text{,J}
\end{aligned}
$$
``` {r sub_type, echo = FALSE, include = FALSE, message = FALSE}
# Conditional model: Substance Type (Tobacco = Intercept)

# drug <- glmer(OSS_1stRef ~  1 + Drugs.1  + (1|School),
#              data= year7, 
#              family = binomial)
#
# alc <- glmer(OSS_1stRef ~  1 + Alcohol.1 + (1|School),
#              data= year7, 
#              family = binomial)
#
# tob <- glmer(OSS_1stRef ~  1 + Tobacco.1 + (1|School),
#              data= year7, 
#              family = binomial)

sub1 <- brm(OSS_1stRef ~ 1 + Alcohol.1 + Drugs.1 + (1|School),
           data= year7,
             family = bernoulli(link = "logit"),
             cores = 2,
             backend = "cmdstan")

summary(sub1)

icc(sub1)

sub <- glmer(OSS_1stRef ~ 1 + Alcohol.1 + Drugs.1 + (1|School),
      data= year7,
      family = binomial,
             control = glmerControl(optimizer = "bobyqa")
)

summary(sub)

icc(sub)
```

```{r sub_model}
exp(fixef(sub))

posterior_sub <- insight::get_parameters(sub)
posterior_sub

# translate to probability:
brms::inv_logit_scaled(fixef(sub))

```

# Results:
  An unconditional model was first run to understand how nesting affected the
outcome variable. The adjusted intra-class correlation for the model was .633,
indicating that 63.3% of the variance in the model is accounted for by variance
at the school-level. This evidence was also used to support the decision to
allow school-level effects to vary randomly to produce a better fitting model.
In the conditional model with substance type as a fixed effect, the ICC was
slightly larger at .701. The Rhat value across all substance type categories and
the intercept was 1.00, indicating that the chains converged well. The
intercept for this model represents the log-likelihood of receiving OSS for
tobacco.
  On average, the log-odds of receiving suspension for possessing a tobacco
substance at school was -.18 (95% credible interval = [-.33, -.03]), for alcohol
was 2.51 -.18 = 2.33 (95% credible interval = [2.35, 2.66]), for drugs was 2.60
-.18 = 2.42 (95% credible interval = [2.50, 2.70]). When run all together,
tobacco is not a significant predictor of Out of School Suspension. Possession
of drugs is the most significant predictor of Out of School Suspension.

# Discussion:
  Sample data is from schools implementing PBIS. Average in schools that do not
implement PBIS may be different. It may be appropriate to include other
parameters in models. Only includes out-of-school suspension, and does not
include other forms of exclusion. Nesting at the district-level would provide
answers to questions about how factors at that level (district culture and
policies) influence use of suspension, but with the present data, nesting at
this level would not have provided those answers. The absence of all substances
in a referral (i.e., the intercept) is impossible because the data set contains
only referrals for substance possession.

# References:

American Psychological Association. (2008). Are zero tolerance policies
effective in the schools? An evidentiary review and recommendations. American
Psychologist, 63, 852-862.

Anyon, Y., Jenson, J. M., Altschul, I., Farrar, J., McQueen, J., Greer, E.,
Downing, B., & Simmons, J. (2014). The persistent effect of race and the promise
of alternatives to suspension in school discipline outcomes. Children and Youth
Services Review, 44, 379-386.

Skiba, R. J., Chung, C., Trachok, M., Baker, T. L., Sheya, A., & Hughes, R. L.
(2014, August 1, 2014). Parsing disciplinary disproportionality: Contributions
of infraction, student, and school characteristics to out-of-school suspension
and expulsion. American Educational Research Journal, 51, 640-670.
https://doi.org/10.3102/0002831214541670