---
title: "SeanDavidBrock_HLM2_Final"
author: "Sean Austin, David Fainstein, Brock Rowley"
date: "5/25/2021"
output: html_document
---

# To do 5/28:
Brock: Code clean-up
Sean: Insert write-up
David: Code for converting to and interpreting probabilities Q2 and Q3

# The final product includes two parts: 
(a) an R script of your analysis and all plots, and 
(b) a writeup of the results of your analysis which should largely match APA
style.
* You will also need to submit the data you are analyzing so I can run your
script locally.

# R Script (20 points) based on the following criteria:
* Reproducibility: 2 points
* Exploratory and descriptive analyses: 3 points
* Analysis: 10 points
* Plots: 5 points

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lme4)
library(here)
library(rio)
library(equatiomatic)
library(easystats)
library(performance)
library(readr)
library(brms)

year7 <- rio::import(here::here("data", "Year7_MLM.sav"))
view(year7)

```
# Introduction: 2 points
Suggested length - one paragraph, 0.5 page max.
Provide a very brief background on the purpose of the study.

  Student substance misuse is an ongoing problem in schools across the United
States, and it is outside the training and expertise of most educators.
Nonetheless, school staff are presented with situations in which students bring
substances to campus or arrive under the influence of them. Despite the evidence
that zero-tolerance policies do not improve school safety or student behavior
(American Psychological Association, 2008), the likely default response in
contemporary schools to substance-related behavior occurs through their
discipline systems. Effective support for these students is most promising if
delivered through a preventative and proactive system as outlined with the
Interconnected Systems Framework (ISF) (Barrett et al., 2013). The ISF advocates
integration and coordination with mental health service providers to meet a broader range of behavioral health needs more effectively. 
Although the national mindset is moving toward a more inclusive approach to behavioral health, this study seeks to determine to what extent school practices have
shifted with it. The objective of this study is to leverage a national office
discipline referral (ODR) dataset to examine the administrative decisions for
substance possession referrals. Specifically, this study seeks to examine how
use of out-of-school suspension (OSS) differs by substance possessed and student
race/ethnicity.

# Data Source:
National School-Wide Information System (SWIS) Referral Data from 2018-19,
restricted to only referrals for substance possession, grades 6-12.

# Explanation of variables:
* School = School ID.
* SID = Student ID.
* RaceEthnicity = Categorical variable of student race.
* OSS_1stRef = True/False (logical) student received Out of School Suspension
(OSS) on first referral in school year for substance possession.
* Alcohol.1, Drugs.1, Tobacco.1 = True/False (logical) student possessed named
substance in 1st referral.
* subtype = categorical variable of substance possessed on first referral.
Mutually exclusive categories eliminate some co-ocurrence that happened.
Probably won't use this variable, but there if needed.
* Gender = Male (0), Female(1)
* ODRCount = # of Office Discipline Refferal (ODRs) for substance in that school
year for each student.
* Grade = grade of student at time of referral.
* IEP = True/False (logical) if student had Individualize Education Plan (IEP)
at time of referral.
* BLW_Sample = Flag for students in schools that had minimum of 5% students in
each abbreviated race category (e.g., B=Black, L=Latinx) race categories
referred for substances in year. Likely not needed for these student-level
analyses.
* Tier1Fidelity: school was implementing Positive Behavioral Intervention
Supports (PBIS) with fidelity (1) or not (0) based on one of three measures that
year.

# Data Processing:
The following steps were taken to prepare the data set for analysis.
A.	Restricting only the 2018-19 school year.
B.	Creating variables within the referral-level dataset.
a.	dummy code use of suspension and expulsion for each referral.
b.	dummy code type of substance possessed for each referral.
C.	Ordering referrals by student ID and date.
D.	Pivoting the dataset wider by student so that referrals, in order of receipt,
were nested with students.
E.	Restricting the sample to 6-12 grades.
F.	Restricting variables to those of interest (see variable definition above)

```{r clean_group}
year7$PrimarySubstanceType.1 <- as.factor(year7$PrimarySubstanceType.1)

year7 %>%
   mutate(subtype = ifelse(PrimarySubstanceType.1 == 13, "Tobacco", 
                     ifelse(PrimarySubstanceType.1 == 14, "Alcohol", "Drugs")), 
          Alcohol.1 = as.factor(year7$Alcohol.1),
          Drugs.1 = as.factor(year7$Drugs.1),
          Tobacco.1 = as.factor(year7$Tobacco.1),
          RaceEthnicity = as.factor(year7$RaceEthnicity),
          School = as.factor(year7$School),
          District = as.factor(year7$District),
          RaceEthnicity = case_when(RaceEthnicity == 1 ~ "Native",
                                    RaceEthnicity == 2 ~ "Asian",
                                    RaceEthnicity == 3 ~ "Latinx",
                                    RaceEthnicity == 4 ~ "Black",
                                    RaceEthnicity == 5 ~ "White",
                                    RaceEthnicity == 8 ~ "Pacific_Islander",
                                    RaceEthnicity == 44 ~ "Multi"),
          RaceEthnicity = as.factor(year7$RaceEthnicity))

grouped <- year7 %>%
  group_by(RaceEthnicity) %>%
  count()
view(grouped)
```

# Research Questions: (2 point)
1. To what extent does the substance a student possessed for their referral (Alcohol, Tobacco, or Drugs) predict whether or not they receive an out of school suspension for substance possession?
2. To what extent does student race predict whether or not a student receives an out of school suspension for substance possession?
3. To what extent is there an interaction between student race and substance in predicting out of school suspension for substance possession?

# Writeup (20 points)
You will develop very short APA writeup of your model results, which should not exceed five pages, double-spaced, with standard 1 inch margins and 12pt Times New Roman font. Manuscripts that exceed the five page limit will have five points removed immediately. As indicated below, you will be required to include at least one figure and at least one table, which along with references, will not count against the page limit. The manuscript should include a (very brief) introduction, methods, results, and a brief discussion including the limitations. As the points below and suggested page limits for each section indicate, the majority of the space should be devoted to the methods and results. The writeup should include the following components:

# Method: (5 points)
Suggested length - 1.5 to 2 pages. Describe where the data came from (one
paragraph). Describe your data preparation (e.g., handling missing data,
transformations). Describe your analytic sample, complete with a table of
descriptive statistics. Describe the model you plan to fit and/or your model
building process and why it is appropriate for your sample and research
question(s). You may optionally include and discuss any exploratory plots here
as well.

# Data Sample
  The data sample for the project comes from the web-based School-Wide
Information System (SWIS) for collecting and analyzing school discipline data in
the form of office discipline referrals (ODRs; May et al., 2013) and containing
all referrals in the 2018-19 school year for possession of substances.  This
dataset included 30,773 students in grades 6-12 across 45 states. Schools in the
2018-19 dataset numbered 1,903 within 1,008 districts. ODRs are completed within
schools through a standard form generated by a school staff member when students
engage in violations of behavioral rules within the school. Within this form,
fields are completed to indicate circumstances in which the behavior took place
(e.g. date, time, location), characteristics of the undesired behavior (e.g.
behavior category, perceived motivation), student characteristics (e.g.
race/ethnicity, gender), and administrative actions taken (e.g. conference,
suspension, expulsion). In addition, within the dataset, National Center for
Educational Statistics (NCES) data characterizing school population (e.g. school
demographics, population size) and setting (e.g. urbanicity) are paired with
each referral. Student race/ethnicity and disability status data are entered by
the school from enrollment records. The sample contained 66% male students and
34% female students, with 15% of all students in the dataset having IEPs. The
majority of students in the dataset were identified as White (52%), followed by
Latinx students (23%), Black/African American students (10%), students of more
than one race (2%), Indigenous students (2%), Pacific Islander students (1%),
and Asian students (1%). The distribution of students by grade in the dataset
was as follows: grade 6 (7%), grade 7 (14%), grade 8 (20%), grade 9 (21%), grade
10 (18%), grade 11 (12%), and grade 12 (8%). The mean number of referrals per
student was 1.21 (SD = 0.569), with a range of 1-14 referrals for students in
the dataset.
  
# Descriptive Analysis
# Add Table of Mean rates by substance and mean rates by race.
# Add Crosstab of possession trends substance X race. Describe different trends in substance type by race/ethnicity.

## Procedure
  ODR data from the SWIS database were extracted following a formal, written data request submitted by this author. For all analyses of administrative actions taken in response to referrals, only a student’s first referral for substance possession was used, meaning any administrative actions in subsequent referrals were not included. This dataset was obtained as a referral-level dataset and required conversion to a student-level dataset by running cases to variables command in SPSS. Analysis was done using only the first referrals for substance possession for each student in the dataset to eliminate concerns about possible confounding of analyses related to decision-making with subsequent referrals. 

## Missing Data
Missing data was handled by listwise deletion for instances where an individual student's race or ethnicity was not available (i.e., listed as Not Applicable, NA). The race or ethnicity identifier was drawn from the National Center on Educational Statistics approach for collecting and disseminating extant data. In this case, 7.7% (2360 of 30773) of the data was removed from analysis because there was insufficient demographic information.

# Measures
## Dependent Variable
	   Administrative decisions are actions taken in response to the behavior violation. Up to five administrative decisions can be listed for each ODR, and there are 14 options built into the SWIS referral form for administrators to choose from to describe their decision(s). Options include time in office, loss of privilege, conference with student, parent contact, timeout/detention, individualized instruction, in-school suspension (ISS), out of school suspension (OSS), expulsion, other administrative decision, unknown administrative decision, bus suspension, and restitution. The definitions for each action taken are provided in the SWIS training materials provided to stewards of data systems within each school. To understand the extent to which exclusionary discipline is used with students possessing substances, referral actions were coded to indicate whether ISS, OSS, any suspension (coded yes if student received either ISS or OSS), or expulsion were used with each individual referral. Per the SWIS training materials, OSS is defined as a 1-3 day period when student is not allowed on campus (although greater than 3 days was frequently reported under this code). 
	
	Independent Variables
	  Substance Type
	    Three substance types are delineated within the SWIS system: Alcohol Possession, Drug Possession, or Tobacco Possession. No additional specification is provided within these codes. For analysis, these codes were turned into dummy-coded variables.
	  Race/Ethnicity
	    The Race/Ethnicity codes available within this dataset follow federal codes, including codes for Asian, Black/African American, Latinx, Multiracial (more than one race), Indigenous, Pacific Islander, and White. This variable was included as a categorical variable. 

## Independent Variables
### Substance Type
  Three substance types are delineated within the SWIS system: Alcohol Possession, Drug Possession, or Tobacco Possession. No additional specification is provided within these codes. For analysis, these codes were turned into dummy-coded variables.
### Race/Ethnicity
  The Race/Ethnicity codes available within this dataset follow federal codes, including codes for Asian, Black/African American, Latinx, Multiracial (more than one race), Indigenous, Pacific Islander, and White. This variable was included as a categorical variable.

# Analytic Plan
  Descriptive analysis indicates some differences in likelihood of receiving OSS based on substance type and student race/ethnicity; however, the crosstab table shows that there are different possession trends by student race/ethnicity. For all research questions, modeling accounted for variance at the individual student and school levels. Modeling with nesting at the district level was considered as well, but over 64% of districts had only one school in the dataset and 85% of districts had two or fewer schools, meaning interpretation of this variance at the district-level would have limited usefulness if analyzed with a three-level model. 
# Q1
  To analyze use of OSS by substance, logistic multi-level modeling was used
  examine differential odds ratios while accounting for variance in decisions
  attributable to nesting at the school-level. Substance type variables were
  modeled with fixed effects, while variance at the school-level was allowed to
  vary as a random effect.

# Q2
  To analyze differences in exclusionary discipline by student Race/Ethnicity,
  multi-level modeling was used with student Race/Ethnicity as fixed effects and
  school varying as a random effect.
  
# Q3
  To analyze to the extent to which an interaction between Substance Type and
  student Race/Ethnicity, a Substance Type X Race/Ethnicity fixed interaction
  term was modeled with OSS varying randomly at the school level.

# Results: (5 points)
Suggested length - 1.5 to 2 pages If appropriate, discuss the results of your
model building process and your model comparisons. Include and discuss at least
one table of your model results. Make sure you link specific coefficients or
model results to your research question. Include at least one plot from your
model that communicates your findings (e.g., perhaps comparing the model
predictions to the raw data, or the model predictions for two or more groups)

# We should plot each model (lines by substance, lines by race, lines of interactions (might be too messy?)

```{r crosstabs}
# crosstabs race by ethnicity
tablesubxrace <- year7 %>%
  group_by(RaceEthnicity, subtype) %>%
  summarise(n = n()) %>%
  spread(subtype, n)
view(tablesubxrace)
summary(district)
```

```{r plots}
# You are required to create one plot from your model that communicates the coefficients, model predictions, or other features. You are welcome to include more than one, but at least one plot should be created.
```

# Discussion: (3 points)
Suggested length - 0.5 to 1 page Briefly note any limitations. Very briefly
mention how your findings link to the extant literature 

Limitations
- Sample is from schools implementing PBIS. Average in schools that do not implement PBIS may be different. 
- It may be appropriate to include other parameters in models
- Only includes out-of-school suspension, and does not include other forms of exclusion
- Nesting at the district-level would provide answers to questions about how factors at that level (district culture and policies) influence use of suspension, but with the present data, nesting at this level would not have provided those answers. 


# General style: (3 points)
The manuscript should generally be free of errors and read similarly to a
manuscript that has been submitted for peer review. APA formatting should be
used, with a formatted bibliography listing all references to the extant
literature.

```{r unconditional_model}
#unconditional models
uncond <- glmer(OSS_1stRef ~ 1 + (1|School), data = year7,
                family = binomial)

# uncond1 <- glmer(OSS_1stRef ~ 1 + (1|School)+ (1|District), data = year7, 
#                 family = binomial)

#look at distribution schools per district: 84% have 2 or fewer
#robust check, remove schools with only 1, run ICC again

arm::display(uncond)

# translate to probability:
brms::inv_logit_scaled(fixef(uncond))

#69% chance of OSS

# Probability for an individual 1 SD below
brms::inv_logit_scaled(-0.40 - 0.95)
# Probability for an individual 1 SD above
brms::inv_logit_scaled(-0.40 + 0.95)

library(broom.mixed)
tidy_uncond <- tidy(uncond, "ran_vals", conf.int = TRUE) %>% 
  mutate(level = fct_reorder(level, estimate))

ggplot(tidy_uncond, aes(estimate, level)) +
  geom_linerange(aes(xmin = conf.low, xmax = conf.high),
                 alpha = 0.01) +
  geom_point(color = "#1DA1F2") +
  # get rid of some plot elements
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank())

library(brms)
install.packages("cmdstanr")
library(cmdstanr)
uncond_brm <- brm(OSS_1stRef ~ 1 + (1|School), data = year7,
            family = bernoulli(link = "logit"),
            cores = 4)
            # backend = "cmdstanr")

##Help! cmdstanr



```

# Research Question One:
Convert log likelihood to probability for each substance in sub model to
understand differential probabilities note: intercept for sub is meaningless.
probabilities compare to referrals for other substances.
``` {r q1}
#conditional models -substance
# When run all together, tobacco does not sig. predict OSS
drug <- glmer(OSS_1stRef ~  1 + Drugs.1  + (1|School), 
             data= year7, 
             family = binomial,
             control = glmerControl(optimizer = "bobyqa")
)
# drug_eq <- extract_eq(drug)

alc <- glmer(OSS_1stRef ~  1 + Alcohol.1 + (1|School), 
             data= year7, 
             family = binomial)
# alc_eq <- extract_eq(alc)

tob <- glmer(OSS_1stRef ~  1 + Tobacco.1 + (1|School), 
             data= year7, 
             family = binomial)
# tob_eq <- extract_eq(tob)
sub <- glmer(OSS_1stRef ~ 1 + Alcohol.1 + Drugs.1 + Tobacco.1 + (1|School),
      data= year7,
      family = binomial,
             control = glmerControl(optimizer = "bobyqa")
)
# sub_eq <- extract_eq(sub)

# subnonest <- glm(OSS_1stRef ~  1 + Alcohol.1 + Drugs.1 + Tobacco.1 , 
#                    data= year7, 
#                    family = binomial)

```

```{r compare_models}
compare_performance(uncond, tob, alc, drug, sub)

conditional_effects(sub)
summary(sub)
confint(sub)
#confint keeps throwing an error and I'm not sure why
exp(coef(sub))

#could compute a mean_diff, like DA did in class. Though, I got a bit lost there too, because we need to know population parameters to input to a bayesian model before building out a likelihood ratio. So I'll start with pseudo code, then show how I might approach it with R

# pred_white <- population_level + year7$RaceEthnicity = White
# pred_latinx <- population_level + year7$RaceEthnicity = latinx
# etc
sub_medians <- year7 %>%
  group_by(RaceEthnicity) # %>% 
  # summarize(raceth_medians = median(pred_white, pred_latinx))

# 
# summary(subnonest)
# summary(sub)
# icc(sub)
# confint(sub)
# 
# exp(fixef(drug)) 
# exp(fixef(alc))
# exp(fixef(tob))
# exp(fixef(sub))
# summary(subnonest) #find code for 

# 
# sub1 <- glmer(OSS_1stRef ~  1 + Alcohol.1 + Drugs.1 + (1|School), 
#              data= year7, 
#              family = binomial)
```

# Research Question Two:
Convert log likelihood to probability for each substance in sub model to
understand differential probabilities.
* Note: intercept for Race is Asian students
```{r q2}
race <- glmer(OSS_1stRef ~ 1 + RaceEthnicity + (1|School),
              data= year7,
              family = binomial)

subxrace <- glmer(OSS_1stRef ~  1 + Alcohol.1 + Drugs.1 + Tobacco.1 +
                    RaceEthnicity + RaceEthnicity:Alcohol.1 +
                    RaceEthnicity:Drugs.1 + RaceEthnicity:Tobacco.1 +
                    (1|School),
             data= year7,
             family = binomial) #specify reference group

summary(uncond)
summary(sub)
summary(sub1)
summary(race)
summary(subxrace)

summary(uncond1)
icc(sub, by_group = TRUE)
summary(sub1)
?icc

# #New dataset restricting to only most diverse schools.
# # Probably only necessary for school-level analysis
# racedata <- year7[ which(year7$BLW_Sample==TRUE), ]
# view(racedata)
```

# Research Question Three:
Interpreting interaction?
3. To what extent is there an interaction between student race and substance in
predicting out of school suspension for substance possession?
```{r Q3}
#q3
#maybe see if we can get separate dummy substances to run

# subxrace2 <- glmer(OSS_1stRef ~  1 + PrimarySubstanceType.1 * RaceEthnicity + 
#                     (1|School), 
#              data= year7, 
#              family = binomial,
#              control = glmerControl(optimizer = "bobyqa"))

subxrace3 <- glmer(OSS_1stRef ~  1 + Alcohol.1 * RaceEthnicity +
                                    Drugs.1 * RaceEthnicity +
                                    Tobacco.1 * RaceEthnicity +
                    (1|School), 
             data= year7, 
             family = binomial,
             control = glmerControl(optimizer = "bobyqa"))
```

``` {r recycled}
            # ifelse(RaceEthnicity == 1, "Native",
            #                     ifelse(RaceEthnicity == 2, "Asian",
            #                     ifelse(RaceEthnicity == 3, "Latinx"))))

# Getting errors trying to conslidate categories,need to figure out how to make missing
# year7 <- year7 %>%
#   mutate(RaceEthnicity = ifelse(RaceEthnicity == 1, "Native",
#                                 ifelse(RaceEthnicity == 2, "Asian",
#                                 ifelse(RaceEthnicity == 3, "Latinx"))))
# 
#                   ifelse(RaceEthnicity == 4, "Black",
#                                 ifelse(RaceEthnicity == 5, "White",
#                                 ifelse(RaceEthnicity == 8, "Pacific_Islander",
#                                 ifelse(RaceEthnicity == 44, "Multi"))))
#                                 
# 
#                                 # ifelse(RaceEthnicity == 6, is.na(), 
#                                 # ifelse(RaceEthnicity == 7, is.na(), )
```

# Current Challenges:
Create at least 4 models to answer core questions
Understanding first the variance accounted for by school and district nesting
Running models for substance type, race, and then race and substance type combined.

Interpretation of coefficients for substance type will be interesting as well. Currently struggling with interpretation of the intercepts and betas in logistic multi-level modeling. The absence of all substances in a referral (i.e., the intercept) is impossible because the dataset contains only referrals for substance possession.