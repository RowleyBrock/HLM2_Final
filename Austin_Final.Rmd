<<<<<<< Updated upstream
---
title: "SeanDavidBrock_HLM2_Final"
author: "Sean Austin, David Fainstein, Brock Rowley"
date: "5/25/2021"
output:
  html_document:
    css: table-style.css
---

# The final product includes two parts: 
(a) an R script of your analysis and all plots, and 
(b) a writeup of the results of your analysis which should largely match APA
style.
* You will also need to submit the data you are analyzing so I can run your
script locally.

# R Script (20 points) based on the following criteria:
* Reproducibility: 2 points
* Exploratory and descriptive analyses: 3 points
* Analysis: 10 points
* Plots: 5 points

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(kableExtra)
library(lme4)
library(here)
library(rio)
library(equatiomatic)
library(performance)
library(readr)
library(brms)
library(insight)
library(broom.mixed)
library(tidybayes)

year7 <- rio::import(here::here("data", "Year7_MLM.sav"))
view(year7)
```
# Introduction

  Student substance misuse is an ongoing problem in schools across the United
States, and it is outside the training and expertise of most educators.
Nonetheless, school staff are presented with situations in which students bring
substances to campus or arrive under the influence of them. Despite the evidence
that zero-tolerance policies do not improve school safety or student behavior
(American Psychological Association, 2008), the likely default response in
contemporary schools to substance-related behavior occurs through their
discipline systems. Effective support for these students is most promising if
delivered through a preventative and proactive system as outlined with the
Interconnected Systems Framework (ISF) (Barrett et al., 2013). The ISF advocates
integration and coordination with mental health service providers to meet a
broader range of behavioral health needs more effectively. Although the national
mindset is moving toward a more inclusive approach to behavioral health, this
study seeks to determine to what extent school practices have shifted with it.
The objective of this study is to leverage a national office discipline referral
(ODR) dataset to examine the administrative decisions for substance possession
referrals. Specifically, this study seeks to examine how use of out-of-school
suspension (OSS) differs by substance possessed and student race/ethnicity.

# Research Questions
1. To what extent does the substance a student possessed for their referral
(Alcohol, Tobacco, or Drugs) predict whether or not they receive an out of
school suspension for substance possession? 

2. To what extent does student race predict whether or not a student receives an
out of school suspension for substance possession?

3. To what extent is there an interaction between student race and substance in
predicting out of school suspension for substance possession?

# Method
##Sample
  The data sample for the project comes from the web-based School-Wide Information
System (SWIS) for collecting and analyzing school discipline data in the form of
office discipline referrals (ODRs; May et al., 2013) following a formal, written
data request submitted by the first author. The sample contained all referrals
in the 2018-19 school year for possession of substances and included
30,773 students in grades 6-12 across 45 states. Schools in the 2018-19 dataset
numbered 1,903 within 1,008 districts. ODRs are completed within schools through
a standard form generated by a school staff member when students engage in
violations of behavioral rules within the school. Within this form, fields are
completed to indicate circumstances in which the behavior took place (e.g. date,
time, location), characteristics of the undesired behavior (e.g. behavior
category, perceived motivation), student characteristics (e.g. race/ethnicity,
gender), and administrative actions taken (e.g. conference, suspension,
expulsion). Student race/ethnicity and disability status data are entered by
the school from enrollment records. The sample contained 66% male students and
34% female students, with 15% of all students in the dataset having IEPs. The
majority of students in the dataset were identified as White (52%), followed by
Latinx students (23%), Black/African American students (10%), students of more
than one race (2%), Indigenous students (2%), Pacific Islander students (1%),
and Asian students (1%). The distribution of students by grade in the dataset
was as follows: grade 6 (7%), grade 7 (14%), grade 8 (20%), grade 9 (21%), grade
10 (18%), grade 11 (12%), and grade 12 (8%). The mean number of referrals per
student was 1.21 (SD = 0.569), with a range of 1-14 referrals for students in
the dataset.

## Procedure
  This dataset was obtained as a referral-level dataset and required conversion to
a student-level dataset by running cases to variables command in SPSS. For all
analyses of administrative actions taken in response to referrals, only a
studentâ€™s first referral for substance possession was used, meaning any
administrative actions in subsequent referrals were not included. Analysis was
done using only the first referrals for substance possession for each student in
the dataset to eliminate concerns about possible confounding of analyses related
to decision-making with subsequent referrals. ### Data Preparation Prior to
beginning this course, the following steps were taken to prepare the data set
for analysis. A.	Restricted only the 2018-19 school year. B.	Created variables
within the referral-level dataset. a.  Dummy coded variable for use of
suspension and expulsion for each referral. b.	Dummy coded variable for type of
substance possessed for each referral. C.	Pivoted the dataset wider by student
so that referrals, in order of date of receipt, were nested with students.
E.	Restricted the sample to 6-12 grades. F.	Restricted variables to those of
interest
For analysis in R, the variables needed to be properly formatted as factors to
use multilevel modeling. In addition, labels were assigned to values in the
RaceEthnicity category to support interpretation of model summaries.
### Missing Data 
  Missing data was handled by listwise deletion for instances where an individual
student's race or ethnicity was not available (i.e., listed as Not Applicable,
NA). The race or ethnicity identifier was drawn from the National Center on
Educational Statistics approach for collecting and disseminating extant data. In
this case, 7.7% (2360 of 30773 observations) of the data was removed from
analyses because there was insufficient demographic information.
## Measures 
### Dependent Variable 
  Administrative decisions are actions taken in response to the behavior
violation. Up to five administrative decisions can be listed for each ODR, and
there are 14 options built into the SWIS referral form for administrators to
choose from to describe their decision(s). Options include time in office, loss
of privilege, conference with student, parent contact, timeout/detention,
individualized instruction, in-school suspension (ISS), out of school suspension
(OSS), expulsion, other administrative decision, unknown administrative
decision, bus suspension, and restitution. The definitions for each action taken
are provided in the SWIS training materials provided to stewards of data systems
within each school. To understand the extent to which exclusionary discipline is
used with students possessing substances, referral actions were coded to
indicate whether ISS, OSS, any suspension (coded yes if student received either
ISS or OSS), or expulsion were used with each individual referral. Per the SWIS
training materials, OSS is defined as a 1-3 day period when student is not
allowed on campus (although greater than 3 days was frequently reported under
this code).
### Independent Variables 
#### Substance Type 
  Three substance types are delineated within the SWIS system: Alcohol Possession,
Drug Possession, or Tobacco Possession. No additional specification is provided
within these codes. For analysis, these codes were turned into dummy-coded
variables. 
#### Race/Ethnicity 
  The Race/Ethnicity codes available within this dataset follow federal codes,
including codes for Asian, Black/African American, Latinx, Multiracial (more
than one race), Indigenous, Pacific Islander, and White. This variable was
included as a categorical variable.

# Add Table of Mean rates by substance and mean rates by race. 
# Add Crosstab of possession trends substance X race. Describe different trends in substance type by race/ethnicity.

# Analytic Plan 
## Descriptive Analysis 
  Mean rates of OSS indicated differences by substance type and student
race/ethnicity; however, the crosstab table shows that there are different
possession trends by student race/ethnicity. For all research questions,
modeling accounted for variance at the individual student and school levels.
Modeling with nesting at the district level was considered as well, but over 64%
of districts had only one school in the dataset and 85% of districts had two or
fewer schools, meaning interpretation of this variance at the district-level
would have limited usefulness if analyzed with a three-level model. 
## Research Question 2
  To analyze differences in exclusionary discipline by student Race/Ethnicity,
multi-level modeling was used with student Race/Ethnicity as fixed effects and
school varying as a random effect. A Bayesian approach was selected in order to
allow for more flexible analysis of differences by race/ethnicity based on the
posterior distribution. Flat, preset priors from the brms package were used as
baseline estimates before introducing model iterations.

# Results 
"Suggested length - 1.5 to 2 pages If appropriate, discuss the results
of your model building process and your model comparisons. Include and discuss
at least one table of your model results. Make sure you link specific
coefficients or model results to your research question. Include at least one
plot from your model that communicates your findings (e.g., perhaps comparing
the model predictions to the raw data, or the model predictions for two or more
groups)"

# Plot estimates by race


#Results
  An unconditional model was first run to understand how nesting affected the
outcome variable. The adjusted intra-class correlation for the model was .633,
indicating that 63.3% of the variance in the model is accounted for by variance
at the school-level. This evidence was also used to support the decision to
allow school-level effects to vary randomly to produce a better fitting model.
In the conditional model with race/ethnicty as a fixed effect, the ICC was
slightly larger at .645. The Rhat value across all race/ethnicity categories and
the intercept was 1.00, indicating that the chains converged well. The intercept
for this model represents the log-likelihood of receiving OSS for Indigenous
students.
On average, the log-odds of receiving suspension for possessing a substance at
school for Indigenous students was .63 (95% credible interval = [.31, .93]), for
Asian students was .63 + .45 = 1.09 (95% credible interval = [.79, 1.40]), for
Latinx students was .63 + .36 = .99 (95% credible interval = [.84, 1.15]), for
Black/African American students was .63 + .4 = 1.03 (95% credible interval =
[.86, 1.21]), for White/Caucasian students was .63 + .06 = .69 (95% credible
interval = [.55, .83]), for Pacific Islander students was .63 + .17 = .80 (95%
credible interval = [.30, 1.286]), and for students of more than one race was
.63 + .25 = .89  (95% credible interval = [.67, 1.11]). Figure 1 illustrates
log-odds of receiving OSS for each student race/ethnicity category captured in
the sample. The credible intervals for most groups overlap, but a few groups did
not overlap with others. Specifically, estimates of log-likelihoods for
White/Caucasian students did not overlap at all with those for students coded as
Black/African American or Latinx.
When converted to a probability value, Indigenous students in this sample had a
66% chance of being suspended, the most likely of any group. White/Caucasian
students in the sample had the lowest likelihood of being suspended at 51%.
Asian students were the second most likely to receive suspension (61%).
Black/African American students were next most likely to receive suspension with
a 60% probability, followed by Latinx students (59%), students of more than one
race (56%), and Pacific Islander students (54%).
  The 95% credible interval crossed zero for White/Caucasian students, with a
fairly even distribution (64% likelihood of being above zero), indicating a
modestly increased likelihood that White/Caucasian students received OSS
compared to Indigenous students. The 95% credible interval also crossed zero for
both Pacific Islander students and students of more than one race; however, with
these groups having much smaller counts of students in the sample, and with 72%
and 95% of their posterior distributions, respectively, resulting in positive values, it
appears more likely than not that students possessing substances in these
racial/ethnic groups received OSS. For all other race/ethnicity categories
(Black/African American, Latinx, Asian), 99% or greater of posterior estimates
were above zero, indicating they were more likely than Indigenous students to be
suspended.
# Discussion 
It is important for school administrators to understand the extent to which implicit bias can affect decision-making in school discipline. Previous literature had confirmed race as a significant predictor suspension from school (Skiba et al., 2014), and that students of color are more likely to receive exclusionary discipline for the same infraction (fighting) compared to White students (Anyon et al., 2014). These findings add to the literature by evaluating to what extent the likelihood of suspension for these more objective behavioral errors depends on student race. The results of this study indicate that there are material differences in likelihood of receiving OSS depending upon the race of the student being referred for substance possession. More specifically, these findings indicate that White students are less likely to receive suspension than both Latinx and Black students. Additionally, Indigenous students appear less likely to receive suspension than students coded as Latinx, Black, Asian, Pacific Islander, and more than one race. 

##Limitations 
  There are several limitations to the findings from this study. First, this
sample is from schools implementing PBIS, and the likelihood of suspension may
differ depending on whether or not a schools is implementing PBIS. Second, this
model does not include other student characteristics that may influence
likelihood of suspension. Third, this study was not able to account for nesting
at the district-level due to small numbers of schools within districts.

```{r clean_group}
year7$PrimarySubstanceType.1 <- as.factor(year7$PrimarySubstanceType.1)

year7 <- year7 %>%
   mutate(subtype = ifelse(PrimarySubstanceType.1 == 13, "Tobacco", 
                     ifelse(PrimarySubstanceType.1 == 14, "Alcohol", "Drugs")), 
          Alcohol.1 = as.factor(year7$Alcohol.1),
          Drugs.1 = as.factor(year7$Drugs.1),
          Tobacco.1 = as.factor(year7$Tobacco.1),
          RaceEthnicity = as.factor(year7$RaceEthnicity),
          School = as.factor(year7$School),
          District = as.factor(year7$District),
          RaceEthnicity = case_when(RaceEthnicity == 1 ~ "Native",
                                    RaceEthnicity == 2 ~ "Asian",
                                    RaceEthnicity == 3 ~ "Latinx",
                                    RaceEthnicity == 4 ~ "Black",
                                    RaceEthnicity == 5 ~ "White",
                                    RaceEthnicity == 8 ~ "Pacific_Islander",
                                    RaceEthnicity == 44 ~ "Multi"),
          RaceEthnicity = as.factor(year7$RaceEthnicity))

grouped <- year7 %>%
  group_by(RaceEthnicity) %>%
  count()
view(grouped)
```


```{r crosstabs}
# crosstabs race ethnicity by primary substance type
tablesubxrace <- year7 %>%
  group_by(RaceEthnicity, subtype) %>%
  summarise(n = n()) %>%
  spread(subtype, n)
view(tablesubxrace)
#summary(district)
kable(
  tablesubxrace,
  format = "html",
  col.names = c("RaceEthnicity", "Alcohol", "Drugs", "Tobacco"),
  align = c("l", "c", "c", "c"),
  caption = "Number of Office Refferals by Race and Substance Type"
  ) %>%
  kable_styling(full_width = TRUE) %>%
  row_spec(row = 0, align = "c") %>%
   footnote(
    general_title = "Note.",
    general = "1 = Native, 2 = Asian, 3 = Latinx, 4 = Black, 5 = White, 8 = Pacific_Islander, 44 = Multi.",
   footnote_as_chunk = TRUE
    )
```

```{r plots}
# You are required to create one plot from your model that communicates the coefficients, model predictions, or other features. You are welcome to include more than one, but at least one plot should be created.

plot <- ggplot(year7, aes(ODRCount,RaceEthnicity)) +
geom_line() +
facet_wrap(~subtype)
```

#Unconditional Model
```{r unconditional_model}
#unconditional models
uncond <- glmer(OSS_1stRef ~ 1 + (1|School), data = year7,
                family = binomial)

# uncond1 <- glmer(OSS_1stRef ~ 1 + (1|School)+ (1|District), data = year7, 
#                 family = binomial)

#look at distribution schools per district: 84% have 2 or fewer
#robust check, remove schools with only 1, run ICC again

icc(uncond)

# translate to probability:
brms::inv_logit_scaled(fixef(uncond))

#69% chance of OSS

# Probability for an individual 1 SD below
brms::inv_logit_scaled(-0.40 - 0.95)
# Probability for an individual 1 SD above
brms::inv_logit_scaled(-0.40 + 0.95)


tidy_uncond <- tidy(uncond, "ran_vals", conf.int = TRUE) %>%
  mutate(level = fct_reorder(level, estimate))

ggplot(tidy_uncond, aes(estimate, level)) +
  geom_linerange(aes(xmin = conf.low, xmax = conf.high),
                 alpha = 0.01) +
  geom_point(color = "#1DA1F2") +
  # get rid of some plot elements
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank())

# needed to install cmdstanr...
# install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
# library(cmdstanr)
# library(posterior)
# library(bayesplot)
# color_scheme_set("brightblue")
# check_cmdstan_toolchain(fix=TRUE)
# install_cmdstan(cores = 2)

uncond_brm <- brm(OSS_1stRef ~ 1 + (1|School), data = year7,
            family = bernoulli(link = "logit"),
            cores = 2,
            backend = "cmdstanr")

summary(uncond_brm)

summary(uncond)
# pp_check(uncond_brm, type = "bars") #this crashed R
plot(uncond_bmr)

m0_posterior <- get_parameters(uncond_brm)
head(uncond_brm)

ggplot(m0_posterior, aes(b_Intercept)) +
  geom_density(fill = "#1DA1F2") +
  geom_vline(aes(xintercept = mean(b_Intercept)),
             color = "magenta",
             size = 1.2)


```

# Research Question Two:
2. To what extent does student race predict whether or not a student receives an out of school suspension for substance possession?
```{r q2}
race <- brm(OSS_1stRef ~ 1 + RaceEthnicity + (1|School),
           data= year7,
             family = bernoulli(link = "logit"),
             cores = 2,
             backend = "cmdstan")
#Model info
summary(race)
icc(race)
conditional_effects(race)

#Plots
posterior_race <- insight::get_parameters(race)
head(posterior_race)

post_indig <- ggplot(posterior_race, aes(b_Intercept))+
  geom_density(fill= "purple")+
  geom_vline(xintercept = 0, 
             color= "gray40",
             linetype = "dashed", size = 1.2)

post_asian <- ggplot(posterior_race, aes(b_RaceEthnicity2))+
  geom_density(fill= "purple")+
  geom_vline(xintercept = 0, 
             color= "gray40",
             linetype = "dashed", size = 1.2)

post_latinx <- ggplot(posterior_race, aes(b_RaceEthnicity3))+
  geom_density(fill= "purple")+
  geom_vline(xintercept = 0, 
             color= "gray40",
             linetype = "dashed", size = 1.2)

post_black <- ggplot(posterior_race, aes(b_RaceEthnicity4))+
  geom_density(fill= "purple")+
  geom_vline(xintercept = 0, 
             color= "gray40",
             linetype = "dashed", size = 1.2)

post_white <- ggplot(posterior_race, aes(b_RaceEthnicity5))+
  geom_density(fill= "purple")+
  geom_vline(xintercept = 0, 
             color= "gray40",
             linetype = "dashed", size = 1.2)

post_pac <- ggplot(posterior_race, aes(b_RaceEthnicity8))+
  geom_density(fill= "purple")+
  geom_vline(xintercept = 0, 
             color= "gray40",
             linetype = "dashed", size = 1.2)

post_more <- ggplot(posterior_race, aes(b_RaceEthnicity44))+
  geom_density(fill= "purple")+
  geom_vline(xintercept = 0, 
             color= "gray40",
             linetype = "dashed", size = 1.2)

#Probability of direction greater than zero

sum(posterior_race$b_Intercept > 0)/ nrow(posterior_race)
sum(posterior_race$b_RaceEthnicity2 > 0)/ nrow(posterior_race)
sum(posterior_race$b_RaceEthnicity3 > 0)/ nrow(posterior_race)
sum(posterior_race$b_RaceEthnicity4 > 0)/ nrow(posterior_race)
sum(posterior_race$b_RaceEthnicity5 > 0)/ nrow(posterior_race)
sum(posterior_race$b_RaceEthnicity8 > 0)/ nrow(posterior_race)
sum(posterior_race$b_RaceEthnicity44 > 0)/ nrow(posterior_race)

# > sum(posterior_race$b_RaceEthnicity44 > 0)/ nrow(posterior_race)
# [1] 0.93525
# > sum(posterior_race$b_RaceEthnicity8 > 0)/ nrow(posterior_race)
# [1] 0.7215
# > sum(posterior_race$b_RaceEthnicity5 > 0)/ nrow(posterior_race)
# [1] 0.6485
# > sum(posterior_race$b_RaceEthnicity4 > 0)/ nrow(posterior_race)
# [1] 0.9945
# > sum(posterior_race$b_RaceEthnicity3 > 0)/ nrow(posterior_race)
# [1] 0.993
# > sum(posterior_race$b_RaceEthnicity2 > 0)/ nrow(posterior_race)
# [1] 0.99
# > sum(posterior_race$b_Intercept > 0)/ nrow(posterior_race)
# [1] 1

#can't get this to work. need to figure out how to call out variable values properly for race. 
pred_byrace <- expand.grid(
  RaceEthnicity = c(2:5, 8, 44),
  School = -999
  ) %>% add_fitted_draws(race, n=500, allow_new_levels = TRUE)

#need to redo variable values to make scale of plot better?
ggplot(pred_byrace, aes(RaceEthnicity, .value))+
  stat_lineribbon()+
  scale_fill_brewer(palette = "Greys")


exponentiate differences. 
1:04


#construct credible intervals for each race
q_ex2 <- quantile(posterior_race$b_Intercept +
                  posterior_race$b_RaceEthnicity2,
         probs = c(0.025, 0.5, 0.975))
q_ex3 <- quantile(posterior_race$b_Intercept +
                  posterior_race$b_RaceEthnicity3,
         probs = c(0.025, 0.5, 0.975))
q_ex4 <- quantile(posterior_race$b_Intercept +
                  posterior_race$b_RaceEthnicity4,
         probs = c(0.025, 0.5, 0.975))
q_ex5 <- quantile(posterior_race$b_Intercept +
                  posterior_race$b_RaceEthnicity5,
         probs = c(0.025, 0.5, 0.975))
q_ex8 <- quantile(posterior_race$b_Intercept +
                  posterior_race$b_RaceEthnicity8,
         probs = c(0.025, 0.5, 0.975))
q_ex44 <- quantile(posterior_race$b_Intercept +
                  posterior_race$b_RaceEthnicity44,
         probs = c(0.025, 0.5, 0.975))



# translate to probability:
brms::inv_logit_scaled(fixef(race))

    # (Intercept)  RaceEthnicity2  RaceEthnicity3  RaceEthnicity4  RaceEthnicity5  RaceEthnicity8 RaceEthnicity44 
    #   0.6547389       0.6098714       0.5890622       0.5982255       0.5140159       0.5417021       0.5631654 
```




